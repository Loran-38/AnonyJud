#!/usr/bin/env python3
"""
Test direct de l'anonymisation avec am√©lioration de mise en page
Sans d√©pendance √† requests - utilise directement les modules internes
"""

import sys
import os
from pathlib import Path
import json
import tempfile

# Ajouter le chemin de l'application
sys.path.append(os.path.join(os.path.dirname(__file__), 'app'))

def test_enhanced_anonymization_direct():
    """Test direct de l'anonymisation am√©lior√©e avec le fichier PDF r√©el"""
    
    print("=" * 70)
    print("üé® TEST DIRECT - ANONYMISATION AVEC AM√âLIORATION DE MISE EN PAGE")
    print("=" * 70)
    
    # Localiser le fichier PDF
    pdf_path = Path(__file__).parent / "../anonyjud-app/Docs/fichiers tests/p25-originale.pdf"
    
    if not pdf_path.exists():
        print(f"‚ùå Fichier non trouv√©: {pdf_path}")
        return False
    
    print(f"‚úÖ Fichier trouv√©: {pdf_path}")
    
    try:
        # Charger le fichier
        with open(pdf_path, 'rb') as f:
            original_content = f.read()
        
        print(f"‚úÖ Fichier charg√©: {len(original_content)} bytes")
        
        # Donn√©es des tiers pour anonymisation
        tiers_data = [
            {
                "numero": 1,
                "nom": "HUISSOUD",
                "prenom": "Laurent",
                "adresse": "304 Chemin de la Poyat 38260 ORNACIEUX-BALBINS",
                "email": "laurent.douget@architecte-expert.com"
            },
            {
                "numero": 2,
                "nom": "IMBERT-FOURNIER-GAUTHIER",
                "prenom": "",
                "societe": "Pyramide avocats"
            },
            {
                "numero": 3,
                "nom": "RIBEIRO",
                "prenom": "",
                "societe": "MA√áONNERIE RIBEIRO"
            }
        ]
        
        print(f"üë• Tiers √† anonymiser: {len(tiers_data)}")
        for i, tier in enumerate(tiers_data, 1):
            nom = tier.get('nom', 'N/A')
            prenom = tier.get('prenom', '')
            societe = tier.get('societe', '')
            print(f"   {i}. {nom} {prenom} {societe}")
        
        # √âTAPE 1: Anonymisation classique
        print(f"\nüîí √âTAPE 1: Anonymisation du texte")
        try:
            from app.main import anonymize_pdf_secure_with_graphics
            
            anonymized_content, mapping = anonymize_pdf_secure_with_graphics(original_content, tiers_data)
            
            print(f"‚úÖ Anonymisation r√©ussie:")
            print(f"   - Taille fichier anonymis√©: {len(anonymized_content)} bytes")
            print(f"   - Substitutions effectu√©es: {len(mapping)}")
            
            for tag, original in mapping.items():
                print(f"     {tag} ‚Üê {original}")
            
            # Sauvegarder le fichier anonymis√© classique
            base_name = os.path.splitext(pdf_path.name)[0]
            anonymized_path = f"{base_name}_ANONYMISE_CLASSIQUE.pdf"
            
            with open(anonymized_path, 'wb') as f:
                f.write(anonymized_content)
            
            print(f"üìÑ Fichier anonymis√© sauvegard√©: {anonymized_path}")
            
        except Exception as e:
            print(f"‚ùå Erreur lors de l'anonymisation: {str(e)}")
            return False
        
        # √âTAPE 2: Am√©lioration de la mise en page
        print(f"\nüé® √âTAPE 2: Am√©lioration de la mise en page")
        try:
            from app.pdf_layout_enhancer import enhance_pdf_layout_after_anonymization
            
            enhanced_content = enhance_pdf_layout_after_anonymization(original_content, anonymized_content)
            
            print(f"‚úÖ Am√©lioration r√©ussie:")
            print(f"   - Taille fichier am√©lior√©: {len(enhanced_content)} bytes")
            print(f"   - Ratio de taille: {len(enhanced_content)/len(original_content):.2f}")
            
            # Sauvegarder le fichier am√©lior√©
            enhanced_path = f"{base_name}_ANONYMISE_AMELIORE.pdf"
            
            with open(enhanced_path, 'wb') as f:
                f.write(enhanced_content)
            
            print(f"üìÑ Fichier am√©lior√© sauvegard√©: {enhanced_path}")
            
        except Exception as e:
            print(f"‚ùå Erreur lors de l'am√©lioration: {str(e)}")
            print(f"‚ö†Ô∏è Le fichier anonymis√© classique reste disponible")
            return False
        
        # √âTAPE 3: Analyse comparative
        print(f"\nüìä √âTAPE 3: Analyse comparative")
        analyze_results(original_content, anonymized_content, enhanced_content, pdf_path.name)
        
        print(f"\nüéâ TEST COMPLET R√âUSSI !")
        print(f"üìÅ Fichiers g√©n√©r√©s:")
        print(f"   - {anonymized_path}")
        print(f"   - {enhanced_path}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur g√©n√©rale: {str(e)}")
        return False

def analyze_results(original_content, anonymized_content, enhanced_content, filename):
    """Analyse comparative des r√©sultats"""
    try:
        import fitz
        
        print("üîç Analyse comparative des PDFs:")
        
        # Analyser le PDF original
        original_doc = fitz.open(stream=original_content, filetype="pdf")
        original_images = 0
        original_text_blocks = 0
        
        for page_num in range(original_doc.page_count):
            page = original_doc[page_num]
            original_images += len(page.get_images())
            text_dict = page.get_text("dict")
            original_text_blocks += len(text_dict.get("blocks", []))
        
        original_doc.close()
        
        # Analyser le PDF anonymis√©
        anon_doc = fitz.open(stream=anonymized_content, filetype="pdf")
        anon_images = 0
        anon_text_blocks = 0
        
        for page_num in range(anon_doc.page_count):
            page = anon_doc[page_num]
            anon_images += len(page.get_images())
            text_dict = page.get_text("dict")
            anon_text_blocks += len(text_dict.get("blocks", []))
        
        anon_doc.close()
        
        # Analyser le PDF am√©lior√©
        enhanced_doc = fitz.open(stream=enhanced_content, filetype="pdf")
        enhanced_images = 0
        enhanced_text_blocks = 0
        
        for page_num in range(enhanced_doc.page_count):
            page = enhanced_doc[page_num]
            enhanced_images += len(page.get_images())
            text_dict = page.get_text("dict")
            enhanced_text_blocks += len(text_dict.get("blocks", []))
        
        enhanced_doc.close()
        
        print(f"üìä Comparaison des √©l√©ments:")
        print(f"   Format           | Images | Blocs Texte | Taille")
        print(f"   Original         |   {original_images:2d}   |     {original_text_blocks:2d}      | {len(original_content):6d}")
        print(f"   Anonymis√©        |   {anon_images:2d}   |     {anon_text_blocks:2d}      | {len(anonymized_content):6d}")
        print(f"   Am√©lior√©         |   {enhanced_images:2d}   |     {enhanced_text_blocks:2d}      | {len(enhanced_content):6d}")
        
        # Calcul des am√©liorations
        image_preservation = enhanced_images / original_images * 100 if original_images > 0 else 100
        text_preservation = enhanced_text_blocks / original_text_blocks * 100 if original_text_blocks > 0 else 100
        
        print(f"\n‚úÖ Taux de pr√©servation:")
        print(f"   - Images: {image_preservation:.1f}%")
        print(f"   - Structure texte: {text_preservation:.1f}%")
        
        if image_preservation >= 90 and text_preservation >= 90:
            print(f"üéâ Excellente pr√©servation des √©l√©ments visuels!")
        elif image_preservation >= 70 and text_preservation >= 70:
            print(f"‚úÖ Bonne pr√©servation des √©l√©ments visuels")
        else:
            print(f"‚ö†Ô∏è Pr√©servation partielle - am√©lioration possible")
        
    except Exception as e:
        print(f"‚ö†Ô∏è Erreur lors de l'analyse comparative: {str(e)}")

def test_module_components():
    """Test des composants individuels du module"""
    
    print("\n" + "-" * 50)
    print("üß™ TEST DES COMPOSANTS INDIVIDUELS")
    print("-" * 50)
    
    try:
        # Test 1: PDFLayoutEnhancer
        print("1. Test PDFLayoutEnhancer...")
        from app.pdf_layout_enhancer import PDFLayoutEnhancer
        enhancer = PDFLayoutEnhancer()
        print("   ‚úÖ PDFLayoutEnhancer import√© et initialis√©")
        
        # Test 2: Fonctions d'anonymisation
        print("2. Test fonctions d'anonymisation...")
        from app.main import anonymize_pdf_secure_with_graphics
        print("   ‚úÖ Fonctions d'anonymisation import√©es")
        
        # Test 3: Fonction utilitaire
        print("3. Test fonction utilitaire...")
        from app.pdf_layout_enhancer import enhance_pdf_layout_after_anonymization
        print("   ‚úÖ Fonction utilitaire import√©e")
        
        # Test 4: Preuve de concept
        print("4. Test preuve de concept...")
        from app.pdf_layout_enhancer import proof_of_concept_extract_reinject_images
        print("   ‚úÖ Preuve de concept import√©e")
        
        print("\n‚úÖ Tous les composants sont disponibles!")
        return True
        
    except ImportError as e:
        print(f"‚ùå Erreur d'import: {str(e)}")
        return False
    except Exception as e:
        print(f"‚ùå Erreur: {str(e)}")
        return False

def main():
    """Fonction principale"""
    
    print("üöÄ D√âMARRAGE DES TESTS DIRECTS")
    print("=" * 70)
    
    # Test 1: Composants
    success1 = test_module_components()
    
    # Test 2: Anonymisation compl√®te
    if success1:
        success2 = test_enhanced_anonymization_direct()
    else:
        success2 = False
        print("‚ö†Ô∏è Tests d'anonymisation ignor√©s car les composants ne sont pas disponibles")
    
    # R√©sum√©
    print("\n" + "=" * 70)
    print("üìä R√âSUM√â DES TESTS")
    print("=" * 70)
    
    print(f"Test des composants: {'‚úÖ R√âUSSI' if success1 else '‚ùå √âCHEC'}")
    print(f"Test anonymisation: {'‚úÖ R√âUSSI' if success2 else '‚ùå √âCHEC'}")
    
    if success1 and success2:
        print("\nüéâ TOUS LES TESTS SONT PASS√âS !")
        print("La fonctionnalit√© d'am√©lioration de mise en page est op√©rationnelle.")
        print("\nüìã Prochaines √©tapes:")
        print("   1. Tester avec l'interface web")
        print("   2. Int√©grer dans le frontend")
        print("   3. Optimiser les performances")
    else:
        print("\n‚ö†Ô∏è Certains tests ont √©chou√©")
        print("V√©rifiez les d√©pendances et la configuration")
    
    return success1 and success2

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1) 